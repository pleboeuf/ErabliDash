<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <link rel="stylesheet" href="/lib/w3schools23.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-grey.css">
    <title>Tableau de bord</title>
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/bower_components/peity/jquery.peity.min.js"></script>
    <script language="javascript" type="text/javascript">
        function wsUri(path) {
            var l = window.location;
            return ((l.protocol === "https:") ? "wss://" : "ws://") + l.hostname + (((l.port != 80) && (l.port != 443)) ? ":" + l.port : "") + l.pathname + path;
        }
        var jsonElement;
        var websocket;

        var tankDefs = [{
            // Note: Capacity in Liters
            code: "RS1",
            capacity: 1,
        }, {
            code: "RS2",
            capacity: 1
        }, {
            code: "RS3",
            capacity: 1
        }, {
            code: "RS4",
            capacity: 1
        }, {
            code: "RS5",
            capacity: 1
        }, {
            code: "RS6",
            capacity: 1
        }, {
            code: "RF1",
            capacity: 1
        }, {
            code: "RF2",
            capacity: 1
        }, {
            code: "RC1",
            capacity: 1
        }, {
            code: "RC2",
            capacity: 1
        }, {
            code: "RHC",
            capacity: 1
        }];

        var devices = [];
        var valves = [];
        var pumps = [];
        var vacuums = [];
        var osmose = [];
        var couleeActive = false;
        var tempAge = 0;
        const maximumAge = 5;
        var actualSiteName;

        function liters2gallons(liters) {
            return Math.ceil(liters / 4.54609188);
        }

        function onLoad() {
            openSocket();
            setInterval(displayDevices, 10000);
            var myURL = document.URL;
            var domaineStart = myURL.indexOf("://") + 3;
            var domaineEnd = myURL.lastIndexOf(":");
            var thisDomain = myURL.substring(domaineStart, domaineEnd);
            var thisSiteNameElement = document.getElementById("siteName");
            var prefix = thisSiteNameElement.innerHTML;
            // if (myURL.search("pl-net.duckdns.org:3300") >= 0 || myURL.search("http://localhost:3300") >= 0) {
            //     prefix = "Serveur Dev. • 'α'";
            // } else if (myURL.search("http://pl-net.duckdns.org:3300") >= 0) {
                // prefix = "Serveur Test • 'ß'";
            // } else {
                prefix = "Érablière&nbsp;Brunelle";
            // }
            // actualSiteName =  prefix + " • " + "(" + thisDomain + ")";
            actualSiteName =  prefix;
            thisSiteNameElement.innerHTML =  actualSiteName;
        }

        function displayTanks() {
            var RStotal = 0;
            var RStotalCap = 0;
            var RFtotal = 0;
            var RFtotalCap = 0;
            var RCtotal = 0;
            var RCtotalCap = 0;
            tankDefs.forEach(function(tank) {
                var tankElementId = 'tank_' + tank.code;
                var tankElement = document.getElementById(tankElementId);
                var contentsElementId = tankElementId + '_contents';
                var contentsElement;
                var percentElementId = tankElementId + '_percent';
                var percentElement;
                var rawValueElementId = tankElementId + '_rawvalue';
                var rawValueElement;
                var capacityElementId = tankElementId + '_capacity';
                var capacityElement;
                var outputElementId = tankElementId + '_output';
                var outputElement;
                var drainElementId = tankElementId + '_drain';
                var drainElement;

                var RStotElement;
                var RStotPCElem;
                var RSdispElement;
                var RSmaxElement;

                var RFtotElement;
                var RFtotPCElement;
                var RFdispElement;
                var RFmaxElement;

                var RCtotElement;
                var RCtotPCElement;
                var RCdispElement;
                var RCmaxElement;

                if (tankElement == null) {
                    tankElement = document.createElement("tr");
                    tankElement.setAttribute('id', tankElementId);
                    tankElement.setAttribute('class', "tank");

                    // Add tank name
                    var nameElement = document.createElement("td");
                    nameElement.setAttribute('class', 'tankname');
                    nameElement.innerHTML = tank.code;
                    if (tank.code == "RS5" || tank.code == "RS6") {
                        nameElement.innerHTML = tank.code + " (ph)";
                    }
                    tankElement.appendChild(nameElement);

                    // Add measured contents (gallons)
                    contentsElement = document.createElement('td');
                    contentsElement.setAttribute('id', contentsElementId);
                    contentsElement.setAttribute('class', 'tankcontents');
                    tankElement.appendChild(contentsElement);

                    // Add measured contents (percent)
                    percentElement = document.createElement('td');
                    percentElement.setAttribute('id', percentElementId);
                    percentElement.setAttribute('class', 'tankpercent');
                    tankElement.appendChild(percentElement);

                    // Add output valve status
                    outputElement = document.createElement('td');
                    outputElement.setAttribute('id', outputElementId);
                    outputElement.setAttribute('class', 'tankoutput');
                    tankElement.appendChild(outputElement);

                    // Add drain valve status
                    drainElement = document.createElement('td');
                    drainElement.setAttribute('id', drainElementId);
                    drainElement.setAttribute('class', 'tankdrain');
                    tankElement.appendChild(drainElement);

                    // Add raw value (millimeters)
                    rawValueElement = document.createElement('td');
                    rawValueElement.setAttribute('id', rawValueElementId);
                    rawValueElement.setAttribute('class', 'rawvalue');
                    tankElement.appendChild(rawValueElement);

                    // Add capacity (gallons)
                    capacityElement = document.createElement('td');
                    capacityElement.setAttribute('id', capacityElementId);
                    capacityElement.setAttribute('class', 'tankcapacity');
                    tankElement.appendChild(capacityElement);

                    document.getElementById('tanklist').appendChild(tankElement);

                    // Add RS1 to RS4 summary
                    RStotPCElem = document.getElementById ('RStotPC');
                    RStotPCElem.setAttribute('class', 'tankpercent');
                    RStotElement = document.getElementById ('RStot');
                    RStotElement.setAttribute('class', 'tankcontents');
                    RSdispElement = document.getElementById('RSdisp');
                    RSdispElement.setAttribute('class', 'tankcontents');
                    RSmaxElement = document.getElementById ('RSmax');
                    RSmaxElement.setAttribute('class', 'tankcapacity');

                    // Add RF1 to RF2 summary
                    RFtotPCElement = document.getElementById ('RFtotPC');
                    RFtotPCElement.setAttribute('class', 'tankpercent');
                    RFtotElement = document.getElementById ('RFtot');
                    RFtotElement.setAttribute('class', 'tankcontents');
                    RFdispElement = document.getElementById('RFdisp');
                    RFdispElement.setAttribute('class', 'tankcontents');
                    RFmaxElement = document.getElementById ('RFmax');
                    RFmaxElement.setAttribute('class', 'tankcapacity');

                    // Add RSC to RC2 summary
                    RCtotPCElement = document.getElementById ('RCtotPC');
                    RCtotPCElement.setAttribute('class', 'tankpercent');
                    RCtotElement = document.getElementById ('RCtot');
                    RCtotElement.setAttribute('class', 'tankcontents');
                    RCdispElement = document.getElementById('RCdisp');
                    RCdispElement.setAttribute('class', 'tankcontents');
                    RCmaxElement = document.getElementById ('RCmax');
                    RCmaxElement.setAttribute('class', 'tankcapacity');

                } else {
                    capacityElement = document.getElementById(capacityElementId);
                    rawValueElement = document.getElementById(rawValueElementId);
                    percentElement = document.getElementById(percentElementId);
                    contentsElement = document.getElementById(contentsElementId);
                    outputElement = document.getElementById(outputElementId);
                    drainElement = document.getElementById(drainElementId);
                    // For summary table
                    RStotPCElem = document.getElementById('RStotPC');
                    RStotElement = document.getElementById('RStot');
                    RSdispElement = document.getElementById('RSdisp')
                    RSmaxElement = document.getElementById('RSmax');

                    RFtotPCElement = document.getElementById ('RFtotPC');
                    RFtotElement = document.getElementById ('RFtot');
                    RFdispElement = document.getElementById('RFdisp')
                    RFmaxElement = document.getElementById('RFmax');

                    RCtotPCElement = document.getElementById ('RCtotPC');
                    RCtotElement = document.getElementById ('RCtot');
                    RCdispElement = document.getElementById('RCdisp')
                    RCmaxElement = document.getElementById('RCmax');
                }
                // Display the data
                var tankPercent = (tank.contents / tank.capacity * 100).toFixed(0);
                tankElement.setAttribute('data-percent', tankPercent);
                capacityElement.innerHTML = liters2gallons(tank.capacity);
                rawValueElement.innerHTML = tank.rawValue;
                percentElement.innerHTML = tankPercent + " % ";
                contentsElement.innerHTML = liters2gallons(tank.contents);
                if (tank.rawValue < 5) {
                    contentsElement.innerHTML = "----";
                }

                // Create the pie chart
                var gaugeElement = document.createElement('span');
                gaugeElement.innerHTML = tankPercent + '/100';
                if (tank.code == 'RHC') {
                    gaugeElement.setAttribute('class', 'fueltankgauge');
                } else {
                    gaugeElement.setAttribute('class', 'tankgauge');
                }
                gaugeElement.setAttribute('data-peity', '{ "fill": ["black", "#eeeeee"], "innerRadius": 0, "radius": 8 }');
                percentElement.appendChild(gaugeElement);

                // Copy the output valve state from the valve table
                if (tank.output !== "none" && tank.output !== undefined) {
                    var outValveElemId = "valve_" + tank.output + "_position";
                    var outValvePosElem = document.getElementById(outValveElemId);
                    var outValvePos = outValvePosElem.innerHTML;
                    if (typeof outValvePos !== null) {
                        outputElement.innerHTML = outValvePos;
                        setIndicatorColor(outputElement, outValvePos);
                    }
                }

                // Copy the drain valve state from the valve table
                if (tank.drain !== "none" && tank.drain !== undefined) {
                    var drainValveElemId = "valve_" + tank.drain + "_position";
                    var drainValvePosElem = document.getElementById(drainValveElemId);
                    var drainValvePos = drainValvePosElem.innerHTML;
                    if (typeof drainValvePos !== null) {
                        drainElement.innerHTML = drainValvePos;
                        setIndicatorColor(drainElement, drainValvePos);
                    }
                }
                // Set color of line based on device lastUpdatedAt
                var tankElem = document.getElementById('tank_' + tank.code);
                setAgeColor(tankElem, tank.device);

                var plusRF2Check = document.getElementById('CheckRF2');
                if (tank.code.search("RS") >= 0 || (plusRF2Check.checked == true && tank.code == 'RF2') ){
                    // console.log("plusRF2Check", plusRF2Check.checked, "Include: ", tank.code);
                    RStotal = RStotal + liters2gallons(tank.contents);
                    RStotalCap = RStotalCap + liters2gallons(tank.capacity);
                    RStotElement.innerHTML = RStotal.toFixed(0);
                    RStotPCElem.innerHTML = (RStotal / RStotalCap * 100).toFixed(0) + '%';
                    RSdispElement.innerHTML = (RStotalCap - RStotal).toFixed(0);
                    RSmaxElement.innerHTML = RStotalCap.toFixed(0);
                }

                if (tank.code == 'RF1' || (plusRF2Check.checked == false && tank.code == 'RF2')){
                    // console.log("plusRF2Check", plusRF2Check.checked, "Include: ", tank.code);
                    RFtotal = RFtotal + liters2gallons(tank.contents);
                    RFtotalCap = RFtotalCap + liters2gallons(tank.capacity);
                    RFtotElement.innerHTML = RFtotal.toFixed(0);
                    RFtotPCElement.innerHTML = (RFtotal / RFtotalCap * 100).toFixed(0) + '%';
                    RFdispElement.innerHTML = (RFtotalCap - RFtotal).toFixed(0);
                    RFmaxElement.innerHTML = RFtotalCap.toFixed(0);
                }

                if (tank.code == 'RC1' || tank.code == 'RC2'){
                    RCtotal = RCtotal + liters2gallons(tank.contents);
                    RCtotalCap = RCtotalCap + liters2gallons(tank.capacity);
                    RCtotElement.innerHTML = RCtotal.toFixed(0);
                    RCtotPCElement.innerHTML = (RCtotal / RCtotalCap * 100).toFixed(0) + '%';;
                    RCdispElement.innerHTML = (RCtotalCap - RCtotal).toFixed(0);
                    RCmaxElement.innerHTML = RCtotalCap.toFixed(0);
                }

            });
            $(".tankgauge").peity("pie", {
                "fill": function(value, index, values) {
                    if (index > 0) {
                        return "#eeeeee";
                    }
                    if (values[0] > 90) {
                        return "red";
                    }
                    if (values[0] > 75) {
                        return "orange";
                    }
                    return "green";
                }
            });
            $(".fueltankgauge").peity("pie", {
                "fill": function(value, index, values) {
                    if (index > 0) {
                        return "#eeeeee";
                    }
                    if (values[0] < 30) {
                        return "orange";
                    }
                    if (values[0] < 15) {
                        return "red";
                    }
                    return "green";
                }
            });
        }

        function functionPlusRF2() {
            var plusRF2Check = document.getElementById('CheckRF2');
            var RFsummaryNameElement = document.getElementById('RFsummaryName');
            if (CheckRF2.checked == true){
                RFsummaryNameElement.innerHTML = "RF1";
            } else {
                RFsummaryNameElement.innerHTML = "RF1 + RF2";
            }
        }

        function displayDevices() {
            var oldestAge = 0;
            var ageDisplayTop = '';
            devices.forEach(function(device) {
                if (device.retired) {
                    return;
                }
                var lastUpdatedAtElemId = 'device_' + device.name + '_lastUpdatedAt';
                var generationElemId = 'device_' + device.name + '_generationId';
                var serialElemId = 'device_' + device.name + '_serial';
                var lastUpdatedAtElem;
                var deviceElemId = 'device_' + device.name;
                if (document.getElementById(deviceElemId) == null) {
                    var deviceElem = document.createElement("tr");
                    deviceElem.setAttribute('id', deviceElemId);
                    document.getElementById('devicelist').appendChild(deviceElem);

                    var nameElement = document.createElement("td");
                    nameElement.innerHTML = device.name;
                    nameElement.setAttribute('class', 'darker');
                    deviceElem.appendChild(nameElement);

                    lastUpdatedAtElem = document.createElement('td');
                    lastUpdatedAtElem.setAttribute('id', lastUpdatedAtElemId);
                    lastUpdatedAtElem.setAttribute('class', 'lighter');
                    deviceElem.appendChild(lastUpdatedAtElem);

                    generationElem = document.createElement('td');
                    generationElem.setAttribute('id', generationElemId);
                    generationElem.setAttribute('class', 'lighter');
                    deviceElem.appendChild(generationElem);

                    serialElem = document.createElement('td');
                    serialElem.setAttribute('id', serialElemId);
                    serialElem.setAttribute('class', 'lighter rawvalue');
                    deviceElem.appendChild(serialElem);
                } else {
                    lastUpdatedAtElem = document.getElementById(lastUpdatedAtElemId);
                    generationElem = document.getElementById(generationElemId);
                    serialElem = document.getElementById(serialElemId);
                }
                var ageInMinutes = Math.floor(getMinutesAgo(new Date(device.lastUpdatedAt)));
                var ageDisplay = '?';
                if (ageInMinutes == 0) {
                    ageDisplay = 'now';
                } else if (ageInMinutes > 0) {
                    ageDisplay = ageInMinutes + ' min.';
                }
                if (ageInMinutes > device.maxDelayMinutes || ageDisplay == '?') {
                    lastUpdatedAtElem.style.color = "FireBrick";
                } else {
                    lastUpdatedAtElem.style.color = "black";
                }
                lastUpdatedAtElem.innerHTML = ageDisplay;
                generationElem.innerHTML = device.generationId;
                serialElem.innerHTML = device.lastEventSerial;

                // Display the yongest age at the top of the screen.
                // If more than 5 min. there's a problem.
                oldestAge = Math.max(ageInMinutes, oldestAge);
                ageDisplayTop = oldestAge + ' min.';
                // console.log('oldestAge: ' + oldestAge + ', ageDisplayTop; ' + ageDisplayTop);
                var lastestUpdateElement = document.getElementById("lastestUpdate");
                if (oldestAge > device.maxDelayMinutes) {
                    lastestUpdateElement.innerHTML = 'Délais:</br>anormal';
                    lastestUpdateElement.style.color = "FireBrick";
                } else {
                    lastestUpdateElement.innerHTML = 'Délais:</br>normal';
                    lastestUpdateElement.style.color = "white";
                }

                // Display outside temperature if available on device RS1
                if (device.name.includes("RS1")) {
                    var tempExtElem = document.getElementById("tempExt");
                    if (typeof tempExtElem !== "undefined" && tempExtElem !== null) {
                        if (device.ambientTemp !== undefined && device.ambientTemp !== 99 && device.ambientTemp !== -127) {
                            tempExtElem.innerHTML = device.ambientTemp + "°C";
                        } else {
                            tempExtElem.innerHTML = "---°C";
                        }
                    }
                }
            });
        }

        function getMinutesAgo(date) {
            return (Math.abs((Date.now() - new Date(date).getTime()) / 1000 / 60));
        }

        function displayValves() {
            valves.forEach(function(valve) {
                var positionElem;
                var positionElemId = 'valve_' + valve.code + '_position';
                var valveElemId = 'valve_' + valve.code;
                if (document.getElementById(valveElemId) == null) {
                    var valveElem = document.createElement("tr");
                    valveElem.setAttribute('id', valveElemId);
                    document.getElementById('valvelist').appendChild(valveElem);

                    var codeElement = document.createElement("td");
                    codeElement.innerHTML = valve.code;
                    valveElem.appendChild(codeElement);

                    positionElem = document.createElement('td');
                    positionElem.setAttribute('id', positionElemId);
                    valveElem.appendChild(positionElem);
                } else {
                    positionElem = document.getElementById(positionElemId);
                }
                positionElem.innerHTML = valve.position;
                setIndicatorColor(positionElem, valve.position);
                // Copy valve VaEC postion to Autres Valves table
                if (valve.code == "VaEC") {
                    var VaECElemId = valve.code + "_position";
                    var VaECElem = document.getElementById(VaECElemId);
                    if (typeof VaECElem !== "undefined" && VaECElem !== null) {
                        VaECElem.innerHTML = valve.position;
                        setIndicatorColor(VaECElem, valve.position);
                        var VaECElem = document.getElementById('valve_' + valve.code);
                        setAgeColor(VaECElem, valve.device);
                    }
                }
                // Copy valve VaTk postion to Autres Valves table
                if (valve.code == "VaTk") {
                    var VaTkElemId = valve.code + "_position";
                    var VaTkElem = document.getElementById(VaTkElemId);
                    if (typeof VaTkElem !== "undefined" && VaTkElem !== null) {
                        VaTkElem.innerHTML = valve.position;
                        setIndicatorColor(VaTkElem, valve.position);
                        var VaTkElem = document.getElementById('valve_' + valve.code);
                        setAgeColor(VaTkElem, valve.device);
                    }
                }
            });
        }

        function displaySiteNameOrError(errNo, err) {
            var thisSiteNameElement = document.getElementById("siteName");
            if (errNo < 0) {
                thisSiteNameElement.innerHTML =  "Alarme Osmose: " + err;
                thisSiteNameElement.style.backgroundColor = "red";
            } else {
                thisSiteNameElement.innerHTML =  actualSiteName;
                thisSiteNameElement.style="display: inline-block;"
            }
        }

        function displayOsmose() {
            osmose.forEach(function(osm) {
                var stateElem;
                var stateElemId = 'Osmose' + '_state';
                stateElem = document.getElementById(stateElemId);
                if (osm.state == 1) {
                    stateElem.innerHTML = "ON";
                    stateElem.style.backgroundColor = "lime";
                } else {
                    stateElem.innerHTML = "OFF";
                    stateElem.style.backgroundColor = "red";
                }

                var fonctionElem;
                var fonctionElemId = 'Osmose' + '_fonction';
                fonctionElem = document.getElementById(fonctionElemId);
                fonctionElem.innerHTML = osm.fonction;

                var alarmCodeElem;
                var alarmCodeElemId = 'Osmose' + '_alarmNo';
                alarmCodeElem = document.getElementById(alarmCodeElemId);
                alarmCodeElem.innerHTML = osm.alarmNo;

                var alarmMsgElem;
                var alarmMsgElemId = 'Osmose_alarmMsg'
                alarmMsgElem = document.getElementById(alarmMsgElemId);
                
                alarmMsgElem.innerHTML = osm.alarmMsg;
                if (osm.alarmNo < 0) {
                    alarmMsgElem.style.backgroundColor = "orange";
                } else {
                    alarmMsgElem.style.backgroundColor = "#e0e0e0"; // gris
                }
                displaySiteNameOrError(osm.alarmNo, osm.alarmMsg);

                var seqElem;
                var seqElemId = 'Osmose' + '_sequence';
                seqElem = document.getElementById(seqElemId);
                seqElem.innerHTML = osm.sequence;

                var runTimeCodeElem;
                var runTimeElemId = 'Osmose' + '_tOperEC';
                runTimeElem = document.getElementById(runTimeElemId);
                runTimeElem.innerHTML = secToHrMin(osm.TempsOperEnCour);

                var rtSeq1234CodeElem;
                var rtSeq1234ElemId = 'Osmose' + '_TempsSeq1234';
                rtSeq1234Elem = document.getElementById(rtSeq1234ElemId);
                rtSeq1234Elem.innerHTML = secToHrMin(osm.TempsSeq1234);

                var rtSeq4321CodeElem;
                var rtSeq4321ElemId = 'Osmose' + '_TempsSeq4321';
                rtSeq4321Elem = document.getElementById(rtSeq4321ElemId);
                rtSeq4321Elem.innerHTML = secToHrMin(osm.TempsSeq4321);

                var tdLavageCodeElem;
                var tdLavageElemId = 'Osmose' + '_TempsDepuisLavage';
                tdLavageElem = document.getElementById(tdLavageElemId);
                tdLavageElem.innerHTML = secToHrMin(osm.TempsDepuisLavage);

                var miseAJourCodeElem;
                var miseAJourElemId = 'Osmose' + '_lastUpdatedAt';
                miseAJourElem = document.getElementById(miseAJourElemId);
                var ageInMinutes = Math.floor(getMinutesAgo(new Date(osm.lastUpdatedAt)));
                miseAJourElem.innerHTML = ageInMinutes + " min.";

                var col1Elem;
                var col1ElemId = 'Osmose' + '_Col1';
                col1Elem = document.getElementById(col1ElemId);
                col1Elem.innerHTML = osm.Col1.toFixed(1);

                var col2Elem;
                var col2ElemId = 'Osmose' + '_Col2';
                col2Elem = document.getElementById(col2ElemId);
                col2Elem.innerHTML = osm.Col2.toFixed(1);

                var col3Elem;
                var col3ElemId = 'Osmose' + '_Col3';
                col3Elem = document.getElementById(col3ElemId);
                col3Elem.innerHTML = osm.Col3.toFixed(1);

                var col4Elem;
                var col4ElemId = 'Osmose' + '_Col4';
                col4Elem = document.getElementById(col4ElemId);
                col4Elem.innerHTML = osm.Col4.toFixed(1);

                var concElem;
                var concElemId = 'Osmose' + '_Conc';
                concElem = document.getElementById(concElemId);
                concElem.innerHTML = osm.Conc.toFixed(1);

                var TempElem;
                var TempElemId = 'Osmose' + '_Temp';
                TempElem = document.getElementById(TempElemId);
                TempElem.innerHTML = osm.Temp.toFixed(1);

                var PresElem;
                var PresElemId = 'Osmose' + '_Pres';
                PresElem = document.getElementById(PresElemId);
                PresElem.innerHTML = osm.Pres;

                var brixSeveElem;
                var brixSeveElemId = 'Osmose' + '_BrixSeve';
                brixSeveElem = document.getElementById(brixSeveElemId);
                brixSeveElem.innerHTML = osm.BrixSeve.toFixed(1);

                var brixConcElem;
                var brixConcElemId = 'Osmose' + '_BrixConc';
                brixConcElem = document.getElementById(brixConcElemId);
                brixConcElem.innerHTML = osm.BrixConc.toFixed(1);

                var pcConcElem;
                var pcConcElemId = 'Osmose' + '_PC_Conc';
                pcConcElem = document.getElementById(pcConcElemId);
                pcConcElem.innerHTML = osm.PC_Conc;

                var gphConcElem;
                var gphConcElemId = 'Osmose' + '_Conc_GPH';
                gphConcElem = document.getElementById(gphConcElemId);
                gphConcElem.innerHTML = osm.Conc_GPH;

                var gphFiltratElem;
                var gphFiltratElemId = 'Osmose' + '_Filtrat_GPH';
                gphFiltratElem = document.getElementById(gphFiltratElemId);
                gphFiltratElem.innerHTML = osm.Filtrat_GPH;

                var gphTotalElem;
                var gphTotalElemId = 'Osmose' + '_Total_GPH';
                gphTotalElem = document.getElementById(gphTotalElemId);
                gphTotalElem.innerHTML = osm.Total_GPH;

                var dureeElem;
                var dureeElemId = 'Osmose' + '_Durée_sec';
                dureeElem = document.getElementById(dureeElemId);
                dureeElem.innerHTML = secToHrMin(osm.runTimeSec);
            })
        }

        function secToHrMin(totalSec) {
            hour = Math.floor(totalSec / 3600);
            min = Math.floor((totalSec - hour * 3600) / 60);
            sec = totalSec - (hour * 3600 + min * 60);
            return pad(hour) + ":" + pad(min);
        }

        function displayPumps() {
            var totalRate = 0;
            var totalVolume = 0;
            var gph = 0;
            var pumpDuty = 0;
            var dateStart;
            allWaterPumps = [false, false, false];
            pumps.forEach(function(pump) {
                var codeElement;
                var codeElementId = 'pump_' + pump.code;
                var stateElem;
                var stateElemId = 'pump_' + pump.code + '_state';
                var dutyElem;
                var dutyElemId = 'pump_' + pump.code + '_duty';
                var rateElem;
                var rateElemId = 'pump_' + pump.code + '_rate';
                var volumeElem;
                var volumeElemId = 'pump_' + pump.code + '_volume';
                var pumpElemId = 'pump_' + pump.code;
                var pumpElem = document.getElementById(pumpElemId);
                if (document.getElementById(pumpElemId) == null) {
                    var pumpElem = document.createElement("tr");
                    pumpElem.setAttribute('id', pumpElemId);
                    var totalRow = document.getElementById('pumptotalrow');
                    totalRow.parentElement.insertBefore(pumpElem, totalRow);

                    codeElement = document.createElement("td");
                    codeElement.innerHTML = pump.code;
                    pumpElem.setAttribute('class', 'pumpcode');
                    // pumpElem.setAttribute('class', 'darker');
                    pumpElem.appendChild(codeElement);

                    stateElem = document.createElement('td');
                    stateElem.setAttribute('id', stateElemId);
                    stateElem.setAttribute('class', 'pumpstate');
                    pumpElem.appendChild(stateElem);

                    dutyElem = document.createElement('td');
                    dutyElem.setAttribute('id', dutyElemId);
                    dutyElem.setAttribute('class', 'pumpduty');
                    pumpElem.appendChild(dutyElem);

                    rateElem = document.createElement('td');
                    rateElem.setAttribute('id', rateElemId);
                    rateElem.setAttribute('class', 'pumprate');
                    pumpElem.appendChild(rateElem);

                    volumeElem = document.createElement('td');
                    volumeElem.setAttribute('id', volumeElemId);
                    volumeElem.setAttribute('class', 'pumpvolume');
                    pumpElem.appendChild(volumeElem);
                } else {
                    stateElem = document.getElementById(stateElemId);
                    dutyElem = document.getElementById(dutyElemId);
                    rateElem = document.getElementById(rateElemId);
                    volumeElem = document.getElementById(volumeElemId)
                }
                setPumpWarning(pumpElem, pump.run2long);
                stateElem.innerHTML = pump.state ? 'ON' : 'OFF';
                setIndicatorColor(stateElem, pump.state);
                if ((pump.duty !== undefined) && (pump.duty >= 0)) {
                    var rate = (pump.duty * pump.capacity_gph);
                }
                if ((pump.volume !== undefined) && (pump.volume >= 0)) {
                    var volume = Math.abs(pump.volume);
                }
                if (pump.code == "P1" || pump.code == "P2" || pump.code == "P3") {
                    totalRate += rate;
                    totalVolume += volume;
                    pumpDuty = (pump.duty * 100).toFixed(1);
                    dutyElem.innerHTML = parseFloat(pumpDuty) || "";
                    rateElem.innerHTML = parseInt(rate) || "";
                    volumeElem.innerHTML = parseInt(volume) || "";

                    // Noter l'état de coulée des pompes.
                    if (pump.couleeEnCour !== undefined){
                        if (pump.code == "P1") {
                            allWaterPumps[0] = pump.couleeEnCour;
                            if (allWaterPumps[0]) {
                                dateStart = pump.debutDeCouleeTS;
                            }
                        } else if (pump.code == "P2") {
                            allWaterPumps[1] = pump.couleeEnCour;
                            if (allWaterPumps[1]) {
                                dateStart = pump.debutDeCouleeTS;
                            }
                        } else if (pump.code == "P3") {
                            allWaterPumps[2] = pump.couleeEnCour;
                            if (allWaterPumps[2]) {
                                dateStart = pump.debutDeCouleeTS;
                            }
                        }                       
                    }
                }
                // Set color of line based on device lastUpdatedAt
                var codeElem = document.getElementById('pump_' + pump.code);
                setAgeColor(codeElem, pump.device);
            });
            checkCouleeEnCour(allWaterPumps, dateStart); // Gérer le message de coulée en cours
            var totalRateElem = document.getElementById('pumptotalrate');
            totalRateElem.innerHTML = parseInt(totalRate) || 0;
            var totalVolumeElem = document.getElementById('volumetotal');
            totalVolumeElem.innerHTML = parseInt(totalVolume) || 0;
        }

        function checkCouleeEnCour(allWaterPumps, dateStart) {
            // console.log(JSON.stringify(allWaterPumps));
            var couleeElem = document.getElementById("coulee");
            var couleeTextElem = document.getElementById("c_text");
            var allPumpsCouleeState = allWaterPumps[0] || allWaterPumps[1] || allWaterPumps[2];

            if (allPumpsCouleeState !== undefined && couleeActive !== undefined) {

                if (allPumpsCouleeState !== couleeActive) { // Changement d'état
                    if (allPumpsCouleeState == true) {
                        // console.log("startCouleeCounter: allPumpsCouleeState= " + allPumpsCouleeState + ", couleeActive= " + couleeActive);
                        couleeActive = allPumpsCouleeState;
                        startCouleeCounter(dateStart);
                        couleeTextElem.innerHTML = "Coulée en cours:  ";
                        couleeElem.style.backgroundColor = "yellow";
                        couleeElem.style.color = "black";
                    } else {
                        // console.log("   STOPCouleeCounter: allPumpsCouleeState= " + allPumpsCouleeState + ", couleeActive= " + couleeActive);
                        couleeActive = allPumpsCouleeState;
                        stopCouleeCounter();
                        couleeTextElem.innerHTML = "Coulée terminée:  ";
                        couleeElem.style.backgroundColor = "#9E9E9E";
                    }

                }
            }
        }

        function displayVacuum() {
            vacuums.forEach(function(vacuum) {
                var vacuumValue = 0;
                var vacuumTemp = 0;
                var vacuumCharge = 0;
                var vacuumIllum = 0;
                var valueElem;
                var valueElemId = 'vacuum_' + vacuum.code + '_value';
                var vacuumElemId = 'vacuum_' + vacuum.code;
                var tempElemId = 'vacuum_' + vacuum.code + '_temp';
                var chargeElemId = 'vacuum_' + vacuum.code + '_percentCharge';
                var illumElemId = 'vacuum_' + vacuum.code + '_lightIntensity';
                var rssiElemId = 'vacuum_' + vacuum.code + '_rssi';
                var updatedElemId = 'vacuum_' + vacuum.code + '_lastUpdate';
                if (document.getElementById(vacuumElemId) == null) {
                    var vacuumElem = document.createElement("tr");
                    vacuumElem.setAttribute('id', vacuumElemId);
                    document.getElementById('vacuumlist').appendChild(vacuumElem);

                    var codeElement = document.createElement("td");
                    codeElement.innerHTML = vacuum.label;
                    codeElement.setAttribute('class', 'vacuumcode');
                    vacuumElem.appendChild(codeElement);

                    valueElem = document.createElement('td');
                    valueElem.setAttribute('id', valueElemId);
                    valueElem.setAttribute('class', 'vacuumvalue');
                    vacuumElem.appendChild(valueElem);

                    // if('temp' in vacuum){
                    tempElem = document.createElement('td');
                    tempElem.setAttribute('id', tempElemId);
                    tempElem.setAttribute('class', 'vacuumtemp');
                    vacuumElem.appendChild(tempElem);
                    // }
                    // if('percentCharge' in vacuum){
                    chargeElem = document.createElement('td');
                    chargeElem.setAttribute('id', chargeElemId);
                    chargeElem.setAttribute('class', 'vacuumtemp');
                    vacuumElem.appendChild(chargeElem);
                    // }
                    // if('lightIntensity' in vacuum){
                    illumElem = document.createElement('td');
                    illumElem.setAttribute('id', illumElemId);
                    illumElem.setAttribute('class', 'vacuumtemp');
                    vacuumElem.appendChild(illumElem);
                    // }
                    // if('rssi' in vacuum){
                    rssiElem = document.createElement('td');
                    rssiElem.setAttribute('id', rssiElemId);
                    rssiElem.setAttribute('class', 'vacuumtemp');
                    vacuumElem.appendChild(rssiElem);
                    // }
                    // if('lastUpdate' in vacuum){
                    updatedElem = document.createElement('td');
                    updatedElem.setAttribute('id', updatedElemId);
                    updatedElem.setAttribute('class', 'vacuumtemp');
                    vacuumElem.appendChild(updatedElem);
                    // }
                } else {
                    valueElem = document.getElementById(valueElemId);
                    if ('temp' in vacuum) {
                        tempElem = document.getElementById(tempElemId);
                    }
                    if ('percentCharge' in vacuum) {
                        chargeElem = document.getElementById(chargeElemId);
                    }
                    if ('lightIntensity' in vacuum) {
                        illumElem = document.getElementById(illumElemId);
                    }
                    if ('rssi' in vacuum) {
                        rssiElem = document.getElementById(rssiElemId);
                    }
                    if ('lastUpdate' in vacuum) {
                        updatedElem = document.getElementById(updatedElemId);
                    }
                }
                vacuumValue = (vacuum.rawValue + vacuum.offset) / 100;
                valueElem.innerHTML = vacuumValue.toFixed(1);
                valueElem.style.textAlign = "right";
                if ('temp' in vacuum) {
                    var vacuumTemp = vacuum.temp;
                    tempElem.innerHTML = vacuumTemp.toFixed(1);
                    tempElem.style.textAlign = "right";
                }
                if ('percentCharge' in vacuum) {
                    var chargeTemp = vacuum.percentCharge;
                    chargeElem.innerHTML = chargeTemp.toFixed(0);
                    chargeElem.style.textAlign = "right";
                    chargeElem.style.backgroundColor = setBatteryColorLineVacuum(vacuum.percentCharge);
                }
                if ('lightIntensity' in vacuum) {
                    var illumTemp = vacuum.lightIntensity;
                    illumElem.innerHTML = illumTemp.toFixed(0);
                    illumElem.style.textAlign = "right";
                }
                if ('rssi' in vacuum) {
                    var signalTemp = "" + vacuum.rssi + ", ?";
                    if ('signalQual' in vacuum) {
                        signalTemp = "" + vacuum.rssi + ", " + vacuum.signalQual;
                    }
                    rssiElem.innerHTML = signalTemp;
                    rssiElem.style.textAlign = "right";
                }
                if ('lastUpdate' in vacuum) {
                    var ageInMinutes = Math.floor(getMinutesAgo(new Date((vacuum.device).lastUpdatedAt)));
                    // console.log("ageInMinutes= ", ageInMinutes);
                    updatedTemp = ageInMinutes;
                    updatedElem.innerHTML = updatedTemp.toFixed(0);
                    updatedElem.style.textAlign = "right";
                }
                var vacuumElem = document.getElementById('vacuum_' + vacuum.code);
                setAgeColor(vacuumElem, vacuum.device);
                updatedElem = document.getElementById(updatedElemId);
                setAgeLineVacuum(updatedElem, vacuum.device);
            });
        }

        function displayTemperatures() {
            devices.forEach(function(device) {
                var ambientTempElemId = 'device_' + device.name + '_ambientTemp';
                var enclosureTempElemId = 'device_' + device.name + '_enclosureTemp';
                var sensorUS100TempElemId = 'device_' + device.name + '_sensorTemp';
                var lastUpdatedAtElem;
                var deviceElemId = 'device_' + device.name;
                if (document.getElementById(deviceElemId) == null) {
                    var deviceElem = document.createElement("tr");
                    deviceElem.setAttribute('id', deviceElemId);
                    document.getElementById('temperaturelist').appendChild(deviceElem);

                    var nameElement = document.createElement("td");
                    nameElement.innerHTML = device.name;
                    deviceElem.appendChild(nameElement);

                    ambientTempElem = document.createElement('td');
                    ambientTempElem.setAttribute('id', ambientTempElemId);
                    deviceElem.appendChild(ambientTempElem);

                    enclosureTempElem = document.createElement('td');
                    enclosureTempElem.setAttribute('id', enclosureTempElemId);
                    deviceElem.appendChild(enclosureTempElem);

                    sensorUS100TempElem = document.createElement('td');
                    sensorUS100TempElem.setAttribute('id', sensorUS100TempElemId);
                    deviceElem.appendChild(sensorUS100TempElem);
                } else {
                    ambientTempElem = document.getElementById(ambientTempElemId);
                    enclosureTempElem = document.getElementById(enclosureTempElemId);
                    sensorUS100TempElem = document.getElementById(sensorUS100TempElemId);
                }

                ambientTempElem.innerHTML = device.ambientTempElemId;
                enclosureTempElem.innerHTML = device.enclosureTempElemId;
                sensorUS100TempElem.innerHTML = device.sensorTemp;
            });
        }

        function setIndicatorColor(IndicatorElem, IndicatorValue) {
            if ((IndicatorValue == "Ouvert") || (IndicatorValue == "Ouverte")) {
                IndicatorElem.style.backgroundColor = "lime"; // Vert lime
            } else if (IndicatorValue == "Fermé") {
                IndicatorElem.style.backgroundColor = "#ff3f3f"; // Rouge
            } else if (IndicatorValue == "Partiel") {
                IndicatorElem.style.backgroundColor = "yellow"; // Jaune
            } else if (IndicatorValue == "Erreur") {
                IndicatorElem.style.backgroundColor = "#bfbfff"; // Bleu
            } else if (IndicatorValue == "OFF" || IndicatorValue == 0) {
                IndicatorElem.style.backgroundColor = "#ff3f3f"; // Rouge
            } else if (IndicatorValue == "ON" || IndicatorValue == 1) {
                IndicatorElem.style.backgroundColor = "lime"; // Vert
            }
        }

        function setPumpWarning(deviceElem, warningState) {
            if (warningState) {
                deviceElem.style.backgroundColor = "orange"; // Alerte orange
            } else {
                deviceElem.style.backgroundColor = "silver"; // Alerte orange
            }
        }

        function setAgeColor(displayElem, deviceDevice) {
            try {
                var lastUpdatedAtElemId = 'device_' + deviceDevice + '_lastUpdatedAt';
                if ((typeof lastUpdatedAtElemId !== undefined) || (typeof lastUpdatedAtElemId !== null)) {
                    var lastUpdatedAtElem = document.getElementById(lastUpdatedAtElemId);
                    if ((typeof displayElem !== undefined) || (typeof displayElem !== null)) {
                        displayElem.style.color = lastUpdatedAtElem.style.color;
                    }
                }
            } catch (err) {
                console.log("lastUpdatedAtElemId: " + lastUpdatedAtElemId + " " + err);
            }
        }

        function setAgeLineVacuum(displayElem, deviceDevice) {
            try {
                var lastUpdatedAtElemId = 'device_' + deviceDevice + '_lastUpdatedAt';
                if ((typeof lastUpdatedAtElemId !== undefined) || (typeof lastUpdatedAtElemId !== null)) {
                    var lastUpdatedAtElem = document.getElementById(lastUpdatedAtElemId);
                    if ((typeof displayElem !== undefined) || (typeof displayElem !== null)) {
                        displayElem.innerHTML = lastUpdatedAtElem.innerHTML;
                    }
                }
            } catch (err) {
                console.log("lastUpdatedAtElemId: " + lastUpdatedAtElemId + " " + err);
            }
        }

        function setBatteryColorLineVacuum(percentCharge) {
            try {
                if (percentCharge >= 70){
                    return "#d0d0d0";               // Light gray - Normal. 70% et plus
                } else if (percentCharge >= 50){
                    return "Orange";                // Orange - Faible. Entre 50% et 69%
                } else {
                    return "Red";                   // Red - Critique. Moins de 50%
                }
            } catch (err) {
                console.log("Erreur: " + err);
            }
        }

        function toggleTablesVisibility(thisTable) {
            var btnElem = document.getElementById(thisTable + "TblBtn");
            var TableElem = document.getElementById(thisTable);
            if (TableElem.style.visibility == "hidden") {
                TableElem.style.visibility = "visible";
                btnElem.innerHTML = "Cacher les " + thisTable;
            } else if (TableElem.style.visibility == "visible") {
                btnElem.innerHTML = "Voir les " + thisTable;
                TableElem.style.visibility = "hidden";
            }
        }

        // Toggle status color
        function toggleStatusColor() {
            var statusElem = document.getElementById("lastestUpdate");
            statusElem.style.backgroundColor = (statusElem.style.backgroundColor == '' ? '#4CAF50' : '');
            setTimeout(function() {
                statusElem.style.backgroundColor = (statusElem.style.backgroundColor == '' ? '#4CAF50' : '');
            }, 500);
        }

        function openSocket() {
            websocket = new WebSocket(wsUri(""), "dashboard-stream");
            websocket.onopen = function(evt) {
                console.log('Socket opened.');
            };
            websocket.onclose = function(evt) {
                console.log('Socket closed.');
                setTimeout(function() {
                    openSocket();
                }, 5000);
            };
            websocket.onmessage = function(msg) {
                var data = JSON.parse(msg.data);
                tankDefs.forEach(function(tankDef, index) {
                    var tank = data.tanks.filter(function(tankData) {
                        return tankData.code == tankDef.code;
                    }).shift();
                    tankDef.device = tank.device;
                    tankDef.rawValue = tank.rawValue;
                    tankDef.contents = (tank.fill == null ? 0 : tank.fill);
                    tankDef.capacity = tank.capacity;
                    tankDef.output = tank.output;
                    tankDef.drain = tank.drain;
                    // console.log("Tank %s at %d: %s, raw= %s", tankDef.code, index, tankDef.contents, tankDef.rawValue);

                    devices = data.devices;
                    valves = data.valves;
                    vacuums = data.vacuum;
                    pumps = data.pumps;
                    osmose = data.osmose;
                    // temperatures = data.temperatures;
                });
                displayDevices();
                displayValves();
                displayTanks();
                displayPumps();
                displayVacuum();
                displayOsmose();
                // displayTemperatures();
                toggleStatusColor();
            };
            websocket.onerror = function(evt) {
                console.error('Error:' + evt);
            };
        }

        var sec = 0;
        var couleTimer;

        function pad(val) {
            return val > 9 ? val : "0" + val;
        }

        function startCouleeCounter(date) {
            couleTimer = setInterval(function() {
                sec = parseInt(Math.abs((Date.now() / 1e3 - new Date(date).getTime())));
                var timeStr = "</br> Durée: " + parseInt(sec / 86400, 10);
                timeStr = timeStr + "j " + pad(parseInt(sec / 3600, 10) % 24);
                timeStr = timeStr + "h " + pad(parseInt(sec / 60, 10) % 60);
                timeStr = timeStr + "m " + pad(sec % 60) + "s";
                document.getElementById("compteurDeTemps").innerHTML = timeStr;
            }, 1000);
            // console.log("Affichage début de coulée");
        }

        function stopCouleeCounter() {
            clearInterval(couleTimer);
            document.getElementById("compteurDeTemps").innerHTML = "";
            // console.log("Affichage fin de coulée");
        }

        setTimeout(function(){
           window.location.reload(1);
       }, 3600000);

        window.addEventListener("load", onLoad, false);
    </script>
    <style>
        body {
            background-color: #eeeeee;
            /*      background-image:url("/images/background.png");
*/
        }

        background-image {
            opacity: 1.0;
            filter: alpha(opacity=25);
            /* For IE8 and earlier */
        }

        table {
            border-style: none;
            /*border-collapse: collapse;*/
        }

        th,
        td {
            border: 1px solid #c6c6c6;
            padding: 0.2em;
        }

        .pumpcode,
        .tankname,
        .vacuumcode,
        th.darker,
        td.darker {
            background-color: rgb(201, 201, 201);
        }

        td.lighter,
        tr.lighter {
            background-color: #e0e0e0;
        }

        .tank {
            border-bottom: solid #ffffff;
        }

        .emptyCell{
            color: rgb(230, 230, 230); 
            border: none;
        }

        .V_position,
        .pumpstate,
        .tankoutput,
        .tankdrain {
            text-align: center;
        }

        .tankcontents,
        .tankpercent,
        .rawvalue,
        .tankcapacity,
        .pumpduty,
        .pumprate,
        .pumpvolume,
        .RStot {
            text-align: right;
        }

        .tankcontents,
        .tankpercent,
        .tankoutput,
        .tankdrain,
        .pumpduty,
        .pumprate,
        .vacuumvalue,
        .vacuumtemp,
        .pumpvolume {
            background-color: #e0e0e0;
        }

        #PVx,
        #vacuums,
        #temperatures,
        #tanks,
        #valveOther,
        #valves {
            float: left;
            padding-right: 2em;
        }
    </style>
</head>

<body>

    <div class="w3-container" , style="width: 100%;", id="page_principale">

        <div class="w3-display-container w3-theme w3-light-grey" , style="width: 100%; height: 70px; display: inline-block; position: fixed;">
            <div class="w3-container w3-display-bottommiddle" , style="width: 70%; height: 70px; display: inline-block;", id="ZoneCentrale">
                <div class="w3-container w3-display-bottomleft" , style="width: 70%; height: 70px; display: inline-block;">
                    <h1 class="w3-display-topleft w3-mobile" , style="display: inline-block;", id="siteName">Serveur de Tests</h1></div>
                <div class="w3-container w3-display-right" , style="width: 30%; height: 70px;" , id="coulee">
                    <h3 class="w3-display" , style="display: inline; font-weight: bold;" , id="c_text"></h3>
                    <h3 class="w3-display" , style="display: inline;" , id="compteurDeTemps"></h3>
                </div>
            </div>
            <div class="w3-container w3-display-left">
                <h2 id="tempExt">0&#176;C<br/></h2></div>
            <div class="w3-container w3-display-right" , style="height: 80px;">
                <h4 id="lastestUpdate"></h4></div>
        </div>

        <div style="margin-top: 70px;", id="tanks">
            <h3>Réservoirs</h3>
            <table id="tanklist">
                <tr>
                    <th class="darker">Code</th>
                    <th class="darker">Cont.
                        <br/>(gal)</th>
                    <th class="darker">Cont.
                        <br/>(%)</th>
                    <th class="darker">Valve
                        <br/>Sortie</th>
                    <th class="darker">Valve
                        <br/>Drain</th>
                    <th>Lect.
                        <br/>(mm)</th>
                    <th>Max
                        <br/>(gal)</th>
                </tr>
            </table>

            <!-- <div class="w3-container" , style="width: 50%;"> -->
            <h3>Sommaire des Réservoirs</h3>
            <table id="totalReservoirs">
                <th class="darker">Total</th>
                <th class="darker">Contenu</th>
                <th class="darker"> Actuel <br/>(gal)</th>
                <th class="darker"> Actuel <br/>(%)</th>
                <th class="darker"> Disp. <br/>(gal)</th>
                <th>Max. <br/> (gal)</th>
                <tr> 
                    <td class="darker", class='tankpercent'>RS1 à RS6 <input type="checkbox" id="CheckRF2"  onclick="functionPlusRF2()">+RF2</td>
                    <td class="lighter">Sève</td>
                    <td class="lighter", id="RStot"></td>
                    <td class="lighter V_position", id="RStotPC"></td>
                    <td class="lighter V_position", id="RSdisp"></td>
                    <td class="lighter V_position", id="RSmax"></td>
                </tr>
                <tr>
                    <td class="darker", id="RFsummaryName">RF1 + RF2</td>
                    <td class="lighter">Filtrat</td>
                    <td class="lighter", id="RFtot"></td>
                    <td class="lighter V_position", id="RFtotPC"></td>
                    <td class="lighter V_position", id="RFdisp"></td>
                    <td class="lighter V_position", id="RFmax"></td>
                </tr>
                <tr>
                    <td class="darker">RC1 + RC2</td>
                    <td class="lighter">Concentré</td>
                    <td class="lighter", id="RCtot"></td>
                    <td class="lighter V_position", id="RCtotPC"></td>
                    <td class="lighter V_position", id="RCdisp"></td>
                    <td class="lighter V_position", id="RCmax"></td>
                </tr>
            </table>

            <!-- </div> -->

            <h3>

            </h3>
            <p></p>
            <a class="w3-btn w3-dark-grey" href="/data.json">Données brutes</a>
            <!-- <button id="devicesTblBtn" , class="w3-btn" onclick="toggleTablesVisibility('devices')">Cacher les devices</button> -->
            <!-- <button id="valvesTblBtn" , class="w3-btn" onclick="toggleTablesVisibility('valves')">Voir les valves</button> -->

            <div id="devices" , style="visibility: visible;">
                <tr>
                    <td>

                        <h3>Devices</h3>
                        <table id="devicelist">
                            <tr>
                                <th class="darker">Name</th>
                                <th class="darker">Updated</th>
                                <th class="darker">Generation</th>
                                <th class="darker">Serial</th>
                            </tr>
                        </table>

                    </td>
                </tr>
            </div>

        </div>
        <!-- id="tanks" -->

        <div style="margin-top: 70px;", id="PVx">

            <div id="pumps">
                <h3>Pompes</h3>
                <table id="pumplist">
                    <tr>
                        <th class="darker">Nom</th>
                        <th class="darker V_position">Etat</th>
                        <th class="darker">Util.
                            <br/>(%)</th>
                        <th class="darker">Débit
                            <br/>(gph)</th>
                        <th class="darker">Vol.
                            <br/>(gal)</th>
                    </tr>
                    <tr id="pumptotalrow" , class="lighter">
                        <td class="darker">Total</td>
                        <td></td>
                        <td></td>
                        <td id="pumptotalrate" , class="pumprate" , style="font-weight: bold;"></td>
                        <td id="volumetotal" , class="pumpvolume" , style="font-weight: bold;"></td>
                    </tr>
                    <!-- This is a bad idea to use table to layout page. To be corrected -->
                    <tr> 
                        <td class="emptyCell">Blank</td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                    </tr>
                    <tr style="border: none;"> 
                        <td  class="emptyCell">Blank</td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                        <td class="emptyCell"></td>
                    </tr>
                </table>


                <h3>Valves Indépendantes</h3>
                <table id="autreValves">
                    <tr>
                        <th class="darker">Code</th>
                        <th class="darker">Description</th>
                        <th class="darker">Position</th>
                    </tr>
                    <tr>
                        <td class="darker">VaEC</td>
                        <td class="lighter">Entré Cabane</td>
                        <td class="lighter V_position" , id="VaEC_position"> </td>
                    </tr>
                    <tr>
                        <td class="darker">VaTk</td>
                        <td class="lighter">Sortie Tankers</td>
                        <td class="lighter V_position" , id="VaTk_position"> </td>
                    </tr>
                </table>
                
                <h2 class="emptyCell">Blank</h2>
                <h2 class="emptyCell">Blank</h2>
                <h3>Osmose</h3>
                <table id="OsmoseSystem">
                    <tr>
                        <th class="darker">Machine</th>
                        <th class="darker">Valeur</th>
                    </tr>
                    <tr>
                        <td class="darker">État</td>         
                        <td class="lighter V_position", id="Osmose_state"></td> </td>                
                    </tr>
                    <tr>
                        <td class="darker">Fonction</td>      
                        <td class="lighter rawvalue", id="Osmose_fonction"> </td>                           
                    </tr>
                    <tr>
                        <td class="darker">Durée opér. en cour</td>
                        <td class="lighter rawvalue", id="Osmose_tOperEC"> </td>                           
                    </tr>
                    <tr>
                        <td class="darker">Durée séq. 1234</td>
                        <td class="lighter rawvalue", id="Osmose_TempsSeq1234"> </td>                               
                    </tr>
                    <tr>
                        <td class="darker">Durée séq. 4321</td>
                        <td class="lighter rawvalue", id="Osmose_TempsSeq4321"> </td>                             
                    </tr>
                    <tr>
                        <td class="darker">T. Depuis lavage</td>
                        <td class="lighter rawvalue", id="Osmose_TempsDepuisLavage"> </td>                               
                    </tr>
                    <tr>
                        <td class="darker">Mise à jour</td>
                        <td class="lighter rawvalue", id="Osmose_lastUpdatedAt"> </td>                             
                    </tr>
                    <tr>
                        <td class="darker">Code alarme</td>
                        <td class="lighter rawvalue", id="Osmose_alarmNo"> </td>                             
                    </tr>
                    <tr>
                        <td class="darker">Message d'alarme</td>
                        <td class="lighter", id="Osmose_alarmMsg"> </td>                               
                    </tr>

                    <th class="darker">Concentration</th>
                    <th class="darker", id="Osmose_Concentration"> </th>
                    <tr>
                        <td class="darker">Séquence</td>
                        <td class="lighter rawvalue", id="Osmose_sequence"> </td>                               
                    </tr>
                    <tr>
                        <td class="darker">Débit Col1 (g/m)</td>
                        <td class="lighter rawvalue", id="Osmose_Col1"> </td>                          
                    </tr>
                    <tr>
                        <td class="darker">Débit Col2 (g/m)</td>
                        <td class="lighter rawvalue", id="Osmose_Col2"> </td>                              
                    </tr>
                    <tr>
                        <td class="darker">Débit Col3 (g/m)</td>
                        <td class="lighter rawvalue", id="Osmose_Col3"> </td>                             
                    </tr>
                    <tr>
                        <td class="darker">Débit Col4 (g/m)</td>
                        <td class="lighter rawvalue", id="Osmose_Col4"> </td>                              
                    </tr>
                    <tr>
                        <td class="darker">Débit Conc. (g/m)</td>
                        <td class="lighter rawvalue", id="Osmose_Conc"> </td>                            
                    </tr>
                    <tr>
                        <td class="darker">Température (°C)</td>
                        <td class="lighter rawvalue", id="Osmose_Temp"> </td>                              
                    </tr>
                    <tr>
                        <td class="darker">Pression (PSI)</td>
                        <td class="lighter rawvalue", id="Osmose_Pres"> </td>                            
                    </tr>
                    <tr>
                        <td class="darker">Brix Sève</td>
                        <td class="lighter rawvalue", id="Osmose_BrixSeve"> </td>                              
                    </tr>
                    <tr>
                        <td class="darker">Brix Concentré</td> 
                        <td class="lighter rawvalue", id="Osmose_BrixConc"> </td>                          
                    </tr>

                    <th class="darker">Sommaire</th>
                    <th class="darker", id="Osmose_Sommaire"> </th>

                    <tr>
                        <td class="darker">PC Conc. (%)</td>
                        <td class="lighter rawvalue", id="Osmose_PC_Conc"> </td>                          
                    </tr>
                    <tr>
                        <td class="darker">Débit Conc. (g/h)</td> 
                        <td class="lighter rawvalue", id="Osmose_Conc_GPH"> </td>                           
                    </tr>
                    <tr>
                        <td class="darker">Débit Filtrat (g/h)</td>
                        <td class="lighter rawvalue", id="Osmose_Filtrat_GPH"> </td>          
                    </tr>
                    <tr>
                        <td class="darker">Débit Total (g/h)</td> 
                        <td class="lighter rawvalue", id="Osmose_Total_GPH"> </td>                           
                    </tr>
                    <tr>
                        <td class="darker">Durée d'Osmose</td> 
                        <td class="lighter rawvalue", id="Osmose_Durée_sec"> </td>                         
                    </tr>

            </table>

        </div>

        </div>
        <!-- id="PVx" -->

        <div style="margin-top: 70px;", id="vacuums">
            <h3>Vacuum</h3>
            <table id="vacuumlist">
                <tr>
                    <th class="darker">Nom</th>
                    <th class="darker">Vac.
                        <br/>(inHg)</th>
                    <th class="darker">Temp.
                        <br/>(°C)</th>
                    <th class="darker">Batt.
                        <br/>(%)</th>
                    <th class="darker">Illum.
                        <br/>(lm)</th>
                    <th class="darker">RSSI,
                        <br/>Qual</th>
                    <th class="darker">Mise à
                        <br/>jour</th>
                </tr>
            </table>
        </div>

    </div>

    <!-- <div class="w3-container w3-quarter"> -->
        <table id="valves" , class="w3-table w3-striped w3-bordered" , style="visibility: hidden;">
            <tr>
                <td>
                    <h3>Valves</h3>
                    <table id="valvelist">
                        <tr>
                            <th>Name</th>
                            <th id="valvesPos">Position</th>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    <!-- </div> -->

</body>
<footer>
</footer>

</html>
